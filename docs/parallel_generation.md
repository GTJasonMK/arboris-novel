# ç« èŠ‚å¹¶è¡Œç”Ÿæˆæ€§èƒ½ä¼˜åŒ–

## æ¦‚è¿°

ç« èŠ‚å¹¶è¡Œç”Ÿæˆæ˜¯ Arboris-Novel v1.1 å¼•å…¥çš„é‡å¤§æ€§èƒ½ä¼˜åŒ–åŠŸèƒ½ï¼Œé€šè¿‡åŒæ—¶å‘èµ·å¤šä¸ª LLM è¯·æ±‚æ¥ç”Ÿæˆç« èŠ‚çš„å¤šä¸ªå€™é€‰ç‰ˆæœ¬ï¼Œ**å¤§å¹…ç¼©çŸ­ç”Ÿæˆæ—¶é—´**ã€‚

---

## æ€§èƒ½æå‡å¯¹æ¯”

### ä¸²è¡Œæ¨¡å¼ï¼ˆv1.0ï¼‰
```
ç‰ˆæœ¬ 1 ç”Ÿæˆä¸­... (10åˆ†é’Ÿ)
ç‰ˆæœ¬ 1 å®Œæˆ âœ“

ç‰ˆæœ¬ 2 ç”Ÿæˆä¸­... (10åˆ†é’Ÿ)
ç‰ˆæœ¬ 2 å®Œæˆ âœ“

ç‰ˆæœ¬ 3 ç”Ÿæˆä¸­... (10åˆ†é’Ÿ)
ç‰ˆæœ¬ 3 å®Œæˆ âœ“

æ€»è€—æ—¶ï¼š30 åˆ†é’Ÿ
```

### å¹¶è¡Œæ¨¡å¼ï¼ˆv1.1ï¼Œé»˜è®¤å¯ç”¨ï¼‰
```
ç‰ˆæœ¬ 1 ç”Ÿæˆä¸­... â”
ç‰ˆæœ¬ 2 ç”Ÿæˆä¸­... â”œâ”€ åŒæ—¶è¿›è¡Œ (10åˆ†é’Ÿ)
ç‰ˆæœ¬ 3 ç”Ÿæˆä¸­... â”˜

æ‰€æœ‰ç‰ˆæœ¬å®Œæˆ âœ“

æ€»è€—æ—¶ï¼š10 åˆ†é’Ÿ
```

**æ€§èƒ½æå‡**ï¼š
- **3 ä¸ªç‰ˆæœ¬**ï¼šä» 30 åˆ†é’Ÿé™è‡³ 10 åˆ†é’Ÿï¼ˆ**æé€Ÿ 67%**ï¼‰
- **2 ä¸ªç‰ˆæœ¬**ï¼šä» 20 åˆ†é’Ÿé™è‡³ 10 åˆ†é’Ÿï¼ˆ**æé€Ÿ 50%**ï¼‰

---

## æŠ€æœ¯å®ç°

### æ ¸å¿ƒæœºåˆ¶

ä½¿ç”¨ Python `asyncio` çš„å¹¶å‘æ§åˆ¶æœºåˆ¶ï¼š

1. **asyncio.Semaphore**ï¼šæ§åˆ¶æœ€å¤§å¹¶å‘è¯·æ±‚æ•°ï¼Œé¿å… API é™æµ
2. **asyncio.gather**ï¼šå¹¶è¡Œæ‰§è¡Œå¤šä¸ªå¼‚æ­¥ä»»åŠ¡ï¼Œç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ
3. **return_exceptions=True**ï¼šå…è®¸éƒ¨åˆ†ç‰ˆæœ¬å¤±è´¥ï¼Œä¸å½±å“å…¶ä»–ç‰ˆæœ¬

### ä»£ç æ¶æ„ï¼ˆwriter.py:235-298ï¼‰

```python
# åˆ›å»ºä¿¡å·é‡æ§åˆ¶å¹¶å‘æ•°
semaphore = asyncio.Semaphore(settings.writer_max_parallel_requests)

async def _generate_with_semaphore(idx: int) -> Dict:
    """å¸¦å¹¶å‘æ§åˆ¶çš„ç”Ÿæˆå‡½æ•°"""
    async with semaphore:  # è·å–ä¿¡å·é‡
        logger.info("å¼€å§‹ç”Ÿæˆç‰ˆæœ¬ %s/%s", idx + 1, version_count)
        result = await _generate_single_version(idx)
        logger.info("ç‰ˆæœ¬ %s/%s ç”Ÿæˆå®Œæˆ", idx + 1, version_count)
        return result

# åˆ›å»ºæ‰€æœ‰ä»»åŠ¡å¹¶å¹¶è¡Œæ‰§è¡Œ
tasks = [_generate_with_semaphore(idx) for idx in range(version_count)]
raw_versions = await asyncio.gather(*tasks, return_exceptions=True)

# å¤„ç†å¼‚å¸¸ç»“æœ
for idx, result in enumerate(raw_versions):
    if isinstance(result, Exception):
        logger.error("ç‰ˆæœ¬ %s ç”Ÿæˆå¤±è´¥: %s", idx + 1, result)
        processed_versions.append({"content": f"ç”Ÿæˆå¤±è´¥: {result}"})
    else:
        processed_versions.append(result)
```

### å¹¶å‘æ§åˆ¶æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·è¯·æ±‚ç”Ÿæˆ 3 ä¸ªç« èŠ‚ç‰ˆæœ¬                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ åˆ›å»º Semaphore  â”‚
        â”‚ (æœ€å¤§å¹¶å‘æ•° 3)  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  åˆ›å»º 3 ä¸ªå¹¶è¡Œä»»åŠ¡       â”‚
    â”‚  Task 1: ç”Ÿæˆç‰ˆæœ¬ 1     â”‚
    â”‚  Task 2: ç”Ÿæˆç‰ˆæœ¬ 2     â”‚
    â”‚  Task 3: ç”Ÿæˆç‰ˆæœ¬ 3     â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”˜
         â”‚       â”‚       â”‚
         â”‚ Semaphore è·å–æˆåŠŸ (3/3)
         â”‚       â”‚       â”‚
         â–¼       â–¼       â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ è°ƒç”¨   â”‚ â”‚ è°ƒç”¨   â”‚ â”‚ è°ƒç”¨   â”‚
    â”‚ LLM    â”‚ â”‚ LLM    â”‚ â”‚ LLM    â”‚
    â”‚ API    â”‚ â”‚ API    â”‚ â”‚ API    â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜
         â”‚         â”‚         â”‚
         â”‚ (10 åˆ†é’Ÿï¼Œå¹¶è¡Œæ‰§è¡Œ)
         â”‚         â”‚         â”‚
         â–¼         â–¼         â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ ç‰ˆæœ¬ 1 â”‚ â”‚ ç‰ˆæœ¬ 2 â”‚ â”‚ ç‰ˆæœ¬ 3 â”‚
    â”‚ å®Œæˆ   â”‚ â”‚ å®Œæˆ   â”‚ â”‚ å®Œæˆ   â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜
         â”‚         â”‚         â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ æ‰€æœ‰ç‰ˆæœ¬å®Œæˆ    â”‚
          â”‚ è€—æ—¶ 10 åˆ†é’Ÿ   â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## é…ç½®è¯´æ˜

### ç¯å¢ƒå˜é‡é…ç½®ï¼ˆ.envï¼‰

```env
# ç« èŠ‚ç”Ÿæˆé…ç½®
WRITER_CHAPTER_VERSION_COUNT=2          # æ¯æ¬¡ç”Ÿæˆçš„ç‰ˆæœ¬æ•°é‡
WRITER_PARALLEL_GENERATION=true         # å¯ç”¨å¹¶è¡Œç”Ÿæˆ
WRITER_MAX_PARALLEL_REQUESTS=3          # æœ€å¤§å¹¶å‘è¯·æ±‚æ•°
```

### é…ç½®é¡¹è¯¦è§£

#### 1. WRITER_CHAPTER_VERSION_COUNT
- **é»˜è®¤å€¼**: 2
- **å–å€¼èŒƒå›´**: 1-10
- **è¯´æ˜**: æ¯æ¬¡ç”Ÿæˆç« èŠ‚æ—¶åˆ›å»ºçš„å€™é€‰ç‰ˆæœ¬æ•°é‡
- **å»ºè®®å€¼**:
  - å¿«é€Ÿè‰ç¨¿ï¼š1 ä¸ªç‰ˆæœ¬
  - æ ‡å‡†åˆ›ä½œï¼š2-3 ä¸ªç‰ˆæœ¬
  - ç²¾ç»†æ‰“ç£¨ï¼š3-5 ä¸ªç‰ˆæœ¬

#### 2. WRITER_PARALLEL_GENERATION
- **é»˜è®¤å€¼**: trueï¼ˆå¯ç”¨ï¼‰
- **è¯´æ˜**: æ˜¯å¦å¯ç”¨å¹¶è¡Œç”Ÿæˆ
- **ä½•æ—¶ç¦ç”¨**:
  - API æœ‰ä¸¥æ ¼çš„é™æµé™åˆ¶
  - æœåŠ¡å™¨å†…å­˜ä¸è¶³
  - éœ€è¦è°ƒè¯•å•ä¸ªç‰ˆæœ¬çš„ç”Ÿæˆè¿‡ç¨‹

#### 3. WRITER_MAX_PARALLEL_REQUESTS
- **é»˜è®¤å€¼**: 3
- **å–å€¼èŒƒå›´**: 1-10
- **è¯´æ˜**: æœ€å¤§å¹¶å‘è¯·æ±‚æ•°ï¼ˆSemaphore é™åˆ¶ï¼‰
- **å»ºè®®å€¼**:
  - DeepSeek APIï¼š3-5ï¼ˆå®˜æ–¹å»ºè®®ï¼‰
  - OpenAI APIï¼š5-10ï¼ˆPlus è´¦æˆ·ï¼‰
  - è‡ªå»º APIï¼šæ ¹æ®æœåŠ¡å™¨è´Ÿè½½è°ƒæ•´

---

## é”™è¯¯å¤„ç†

### éƒ¨åˆ†ç‰ˆæœ¬å¤±è´¥

å¹¶è¡Œç”Ÿæˆä½¿ç”¨äº† `return_exceptions=True`ï¼Œå…è®¸éƒ¨åˆ†ç‰ˆæœ¬å¤±è´¥ï¼š

```python
# ç¤ºä¾‹ï¼š3 ä¸ªç‰ˆæœ¬ä¸­ 1 ä¸ªå¤±è´¥
ç‰ˆæœ¬ 1: æˆåŠŸ âœ“
ç‰ˆæœ¬ 2: å¤±è´¥ âœ— (ç½‘ç»œé”™è¯¯)
ç‰ˆæœ¬ 3: æˆåŠŸ âœ“

ç»“æœï¼š2 ä¸ªå¯ç”¨ç‰ˆæœ¬ï¼Œ1 ä¸ªå¤±è´¥ç‰ˆæœ¬ï¼ˆæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ï¼‰
```

**å¤±è´¥ç‰ˆæœ¬çš„å¤„ç†**ï¼š
- åœ¨å€™é€‰ç‰ˆæœ¬åˆ—è¡¨ä¸­æ˜¾ç¤ºä¸º"ç”Ÿæˆå¤±è´¥ï¼š[é”™è¯¯ä¿¡æ¯]"
- ç”¨æˆ·å¯ä»¥é€‰æ‹©æˆåŠŸçš„ç‰ˆæœ¬æˆ–é‡æ–°ç”Ÿæˆ
- ä¸ä¼šé˜»å¡å…¶ä»–ç‰ˆæœ¬çš„ç”Ÿæˆ

### å…¨éƒ¨ç‰ˆæœ¬å¤±è´¥

å¦‚æœæ‰€æœ‰ç‰ˆæœ¬éƒ½å¤±è´¥ï¼ˆæå°‘æƒ…å†µï¼‰ï¼Œç³»ç»Ÿä¼šï¼š
1. è®°å½•è¯¦ç»†é”™è¯¯æ—¥å¿—
2. è¿”å›é”™è¯¯æç¤ºç»™ç”¨æˆ·
3. å»ºè®®ç”¨æˆ·æ£€æŸ¥ç½‘ç»œæˆ– API é…ç½®

---

## æ€§èƒ½ç›‘æ§

### æ—¥å¿—ç¤ºä¾‹

**å¹¶è¡Œæ¨¡å¼**ï¼š
```
INFO: é¡¹ç›® xxx ç¬¬ 1 ç« è®¡åˆ’ç”Ÿæˆ 3 ä¸ªç‰ˆæœ¬ï¼ˆå¹¶è¡Œæ¨¡å¼ï¼šTrueï¼‰
INFO: é¡¹ç›® xxx ç¬¬ 1 ç« å¼€å§‹ç”Ÿæˆç‰ˆæœ¬ 1/3
INFO: é¡¹ç›® xxx ç¬¬ 1 ç« å¼€å§‹ç”Ÿæˆç‰ˆæœ¬ 2/3
INFO: é¡¹ç›® xxx ç¬¬ 1 ç« å¼€å§‹ç”Ÿæˆç‰ˆæœ¬ 3/3
INFO: é¡¹ç›® xxx ç¬¬ 1 ç« ç‰ˆæœ¬ 1/3 ç”Ÿæˆå®Œæˆ
INFO: é¡¹ç›® xxx ç¬¬ 1 ç« ç‰ˆæœ¬ 2/3 ç”Ÿæˆå®Œæˆ
INFO: é¡¹ç›® xxx ç¬¬ 1 ç« ç‰ˆæœ¬ 3/3 ç”Ÿæˆå®Œæˆ
INFO: é¡¹ç›® xxx ç¬¬ 1 ç« æ‰€æœ‰ç‰ˆæœ¬ç”Ÿæˆå®Œæˆï¼Œè€—æ—¶ 612.34 ç§’ï¼ˆå¹¶è¡Œæ¨¡å¼ï¼šTrueï¼‰
```

**ä¸²è¡Œæ¨¡å¼**ï¼š
```
INFO: é¡¹ç›® xxx ç¬¬ 1 ç« è®¡åˆ’ç”Ÿæˆ 3 ä¸ªç‰ˆæœ¬ï¼ˆå¹¶è¡Œæ¨¡å¼ï¼šFalseï¼‰
INFO: é¡¹ç›® xxx ç¬¬ 1 ç« å¼€å§‹ç”Ÿæˆç‰ˆæœ¬ 1/3ï¼ˆä¸²è¡Œæ¨¡å¼ï¼‰
INFO: é¡¹ç›® xxx ç¬¬ 1 ç« å¼€å§‹ç”Ÿæˆç‰ˆæœ¬ 2/3ï¼ˆä¸²è¡Œæ¨¡å¼ï¼‰
INFO: é¡¹ç›® xxx ç¬¬ 1 ç« å¼€å§‹ç”Ÿæˆç‰ˆæœ¬ 3/3ï¼ˆä¸²è¡Œæ¨¡å¼ï¼‰
INFO: é¡¹ç›® xxx ç¬¬ 1 ç« æ‰€æœ‰ç‰ˆæœ¬ç”Ÿæˆå®Œæˆï¼Œè€—æ—¶ 1834.12 ç§’ï¼ˆå¹¶è¡Œæ¨¡å¼ï¼šFalseï¼‰
```

### æ€§èƒ½æŒ‡æ ‡

ä»æ—¥å¿—ä¸­å¯ä»¥æå–ï¼š
- **æ€»è€—æ—¶**ï¼šelapsed_timeï¼ˆç§’ï¼‰
- **å¹³å‡æ¯ç‰ˆæœ¬è€—æ—¶**ï¼štotal_time / version_count
- **å¹¶è¡Œæ•ˆç‡**ï¼š(ä¸²è¡Œè€—æ—¶ - å¹¶è¡Œè€—æ—¶) / ä¸²è¡Œè€—æ—¶ Ã— 100%

---

## å¸¸è§é—®é¢˜

### Q1: å¯ç”¨å¹¶è¡Œç”Ÿæˆåé‡åˆ° 429 é™æµé”™è¯¯ï¼Ÿ

**åŸå› **ï¼šå¹¶å‘è¯·æ±‚è¶…è¿‡ API æä¾›å•†çš„é™æµé™åˆ¶

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. é™ä½ `WRITER_MAX_PARALLEL_REQUESTS` å€¼ï¼ˆå¦‚ä» 5 é™è‡³ 3ï¼‰
2. å‡å°‘ `WRITER_CHAPTER_VERSION_COUNT`ï¼ˆå¦‚ä» 5 é™è‡³ 2ï¼‰
3. å‡çº§ API è´¦æˆ·ç­‰çº§æˆ–ä½¿ç”¨è‡ªå·±çš„ API Key

### Q2: å¹¶è¡Œç”Ÿæˆæ˜¯å¦ä¼šæ¶ˆè€—æ›´å¤š API é¢åº¦ï¼Ÿ

**ç­”æ¡ˆ**ï¼šä¸ä¼šã€‚

å¹¶è¡Œç”Ÿæˆåªæ˜¯æ”¹å˜äº†**æ‰§è¡Œé¡ºåº**ï¼Œæ€»çš„ API è°ƒç”¨æ¬¡æ•°ä¸å˜ï¼š
- ä¸²è¡Œï¼š3 æ¬¡è°ƒç”¨ï¼Œä¾æ¬¡æ‰§è¡Œ
- å¹¶è¡Œï¼š3 æ¬¡è°ƒç”¨ï¼ŒåŒæ—¶æ‰§è¡Œ

### Q3: å¦‚ä½•éªŒè¯å¹¶è¡Œç”Ÿæˆæ˜¯å¦ç”Ÿæ•ˆï¼Ÿ

**æ–¹æ³•**ï¼š
1. æŸ¥çœ‹åç«¯æ—¥å¿—ï¼Œç¡®è®¤æ—¥å¿—ä¸­æ˜¾ç¤º "å¹¶è¡Œæ¨¡å¼ï¼šTrue"
2. è§‚å¯Ÿç”Ÿæˆæ—¶é—´ï¼Œ3 ä¸ªç‰ˆæœ¬åº”æ¥è¿‘å•ä¸ªç‰ˆæœ¬çš„è€—æ—¶
3. æ£€æŸ¥æ—¥å¿—ä¸­å¤šä¸ªç‰ˆæœ¬æ˜¯å¦å‡ ä¹åŒæ—¶å¼€å§‹

### Q4: å¹¶è¡Œç”Ÿæˆæ˜¯å¦å®‰å…¨ï¼Ÿ

**ç­”æ¡ˆ**ï¼šæ˜¯çš„ã€‚

- âœ… **æ•°æ®éš”ç¦»**ï¼šæ¯ä¸ªç‰ˆæœ¬ç‹¬ç«‹ç”Ÿæˆï¼Œä¸ä¼šç›¸äº’å½±å“
- âœ… **å¼‚å¸¸éš”ç¦»**ï¼šéƒ¨åˆ†ç‰ˆæœ¬å¤±è´¥ä¸å½±å“å…¶ä»–ç‰ˆæœ¬
- âœ… **èµ„æºæ§åˆ¶**ï¼šä½¿ç”¨ Semaphore é™åˆ¶å¹¶å‘ï¼Œé¿å…è¿‡è½½
- âœ… **å‘åå…¼å®¹**ï¼šå¯éšæ—¶åˆ‡æ¢å›ä¸²è¡Œæ¨¡å¼

### Q5: å†…å­˜å ç”¨ä¼šå¢åŠ å—ï¼Ÿ

**ç­”æ¡ˆ**ï¼šä¼šç•¥æœ‰å¢åŠ ï¼Œä½†åœ¨å¯æ¥å—èŒƒå›´å†…ã€‚

- ä¸²è¡Œæ¨¡å¼ï¼šåŒä¸€æ—¶é—´åªæœ‰ 1 ä¸ªè¯·æ±‚åœ¨å†…å­˜ä¸­
- å¹¶è¡Œæ¨¡å¼ï¼šåŒä¸€æ—¶é—´æœ‰ N ä¸ªè¯·æ±‚åœ¨å†…å­˜ä¸­ï¼ˆN = MAX_PARALLEL_REQUESTSï¼‰

å¯¹äºé»˜è®¤é…ç½®ï¼ˆ3 ä¸ªå¹¶å‘ï¼‰ï¼Œé¢å¤–å†…å­˜å ç”¨çº¦ä¸º **50-100MB**ï¼Œå¯¹ç°ä»£æœåŠ¡å™¨å½±å“ä¸å¤§ã€‚

---

## æœªæ¥ä¼˜åŒ–æ–¹å‘

### 1. è‡ªé€‚åº”å¹¶å‘æ§åˆ¶
æ ¹æ® API å“åº”æ—¶é—´å’Œé”™è¯¯ç‡åŠ¨æ€è°ƒæ•´å¹¶å‘æ•°ï¼š
```python
if error_rate > 0.2:
    max_parallel_requests -= 1  # é™ä½å¹¶å‘
elif avg_response_time < 5.0:
    max_parallel_requests += 1  # æå‡å¹¶å‘
```

### 2. è¯·æ±‚é˜Ÿåˆ—
å¯¹äºå¤§æ‰¹é‡ç”Ÿæˆä»»åŠ¡ï¼ˆå¦‚ç”Ÿæˆæ•´æœ¬ä¹¦ï¼‰ï¼Œä½¿ç”¨é˜Ÿåˆ—ç³»ç»Ÿé¿å…åŒæ—¶å‘èµ·è¿‡å¤šè¯·æ±‚ï¼š
```python
from celery import Celery

@celery.task
def generate_chapter_async(project_id, chapter_number):
    # å¼‚æ­¥ç”Ÿæˆç« èŠ‚
    pass
```

### 3. ç»“æœç¼“å­˜
ç¼“å­˜å·²ç”Ÿæˆçš„ç‰ˆæœ¬ï¼Œé¿å…é‡å¤è¯·æ±‚ï¼š
```python
cache_key = f"chapter:{project_id}:{chapter_number}:version:{idx}"
if cached := redis.get(cache_key):
    return json.loads(cached)
```

### 4. è´Ÿè½½å‡è¡¡
æ”¯æŒå¤šä¸ª API Key è½®æµä½¿ç”¨ï¼Œåˆ†æ•£å‹åŠ›ï¼š
```python
api_keys = [key1, key2, key3]
selected_key = api_keys[idx % len(api_keys)]
```

---

## æŠ€æœ¯ç»†èŠ‚

### ä¸ºä»€ä¹ˆä½¿ç”¨ Semaphore è€Œä¸æ˜¯ç›´æ¥ gatherï¼Ÿ

**ä¸ä½¿ç”¨ Semaphore**ï¼ˆä¸æ¨èï¼‰ï¼š
```python
# æ‰€æœ‰è¯·æ±‚ç«‹å³å‘èµ·ï¼Œå¯èƒ½è¶…è¿‡ API é™æµ
tasks = [generate(idx) for idx in range(100)]
await asyncio.gather(*tasks)
```

**ä½¿ç”¨ Semaphore**ï¼ˆæ¨èï¼‰ï¼š
```python
# æœ€å¤šåŒæ—¶ 3 ä¸ªè¯·æ±‚ï¼Œå…¶ä»–è¯·æ±‚æ’é˜Ÿç­‰å¾…
semaphore = asyncio.Semaphore(3)
async def generate_with_limit(idx):
    async with semaphore:  # è·å–è®¸å¯
        return await generate(idx)

tasks = [generate_with_limit(idx) for idx in range(100)]
await asyncio.gather(*tasks)
```

### return_exceptions=True çš„ä½œç”¨

**ä¸ä½¿ç”¨**ï¼ˆé»˜è®¤è¡Œä¸ºï¼‰ï¼š
```python
# ä»»ä½•ä¸€ä¸ªç‰ˆæœ¬å¤±è´¥ï¼Œæ‰€æœ‰ä»»åŠ¡éƒ½ä¼šè¢«å–æ¶ˆ
await asyncio.gather(*tasks)  # ç‰ˆæœ¬ 2 å¤±è´¥ â†’ å–æ¶ˆç‰ˆæœ¬ 1 å’Œ 3
```

**ä½¿ç”¨**ï¼ˆæ¨èï¼‰ï¼š
```python
# ç‰ˆæœ¬ 2 å¤±è´¥ï¼Œä½†ç‰ˆæœ¬ 1 å’Œ 3 ç»§ç»­æ‰§è¡Œ
results = await asyncio.gather(*tasks, return_exceptions=True)
# results = [ç‰ˆæœ¬1å†…å®¹, Exception(...), ç‰ˆæœ¬3å†…å®¹]
```

---

## ç›¸å…³ä»£ç æ–‡ä»¶

- `backend/app/api/routers/writer.py:235-298` - å¹¶è¡Œç”Ÿæˆå®ç°
- `backend/app/core/config.py:80-91` - é…ç½®é¡¹å®šä¹‰
- `backend/.env:32-35` - ç¯å¢ƒå˜é‡é…ç½®

---

## å˜æ›´æ—¥å¿—

### v1.1 (2025-01-25)
- âœ¨ æ–°å¢ï¼šç« èŠ‚å¹¶è¡Œç”ŸæˆåŠŸèƒ½
- âœ¨ æ–°å¢ï¼šWRITER_PARALLEL_GENERATION é…ç½®é¡¹
- âœ¨ æ–°å¢ï¼šWRITER_MAX_PARALLEL_REQUESTS é…ç½®é¡¹
- âš¡ æ€§èƒ½ï¼šç”Ÿæˆé€Ÿåº¦æå‡ 50-67%
- ğŸ› ä¿®å¤ï¼šéƒ¨åˆ†ç‰ˆæœ¬å¤±è´¥ä¸å½±å“å…¶ä»–ç‰ˆæœ¬
- ğŸ“ æ–‡æ¡£ï¼šæ–°å¢å¹¶è¡Œç”Ÿæˆæ€§èƒ½ä¼˜åŒ–æ–‡æ¡£

---

**æœ€åæ›´æ–°**: 2025-01-25
**ç‰ˆæœ¬**: v1.1
**ä½œè€…**: Arboris-Novel å¼€å‘å›¢é˜Ÿ
