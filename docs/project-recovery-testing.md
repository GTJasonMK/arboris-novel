# 未完成项目恢复功能测试文档

## 修复概述

### 问题描述
小说工作台显示的项目中，有些项目连灵感模式都未完成（还在概念对话阶段，没有生成蓝图）。之前的实现基于项目标题判断是否应该跳转到灵感模式继续对话，这种方式不可靠。

### 解决方案
添加项目状态字段到项目摘要信息中，基于准确的状态字段判断项目应该跳转到哪个界面。

### 修改内容

#### 1. 后端修改

**文件：`backend/app/schemas/novel.py`**
- 在 `NovelProjectSummary` 类中添加 `status: str` 字段
- 注释说明：项目状态包括 draft, blueprint_ready, need_part_outlines 等

**文件：`backend/app/services/novel_service.py`**
- 修改 `list_projects_for_user` 方法
- 在构建 `NovelProjectSummary` 时添加 `status=project.status`
- 位置：第 173 行

#### 2. 前端修改

**文件：`frontend/src/api/novel.ts`**
- 在 `NovelProjectSummary` interface 中添加 `status: string` 字段

**文件：`frontend/src/views/NovelWorkspace.vue`**
- 修改 `enterProject` 函数（第 173-181 行）
- 之前：根据 `title === '未命名灵感'` 判断
- 现在：根据 `status === 'draft'` 判断
- 逻辑：
  - `status === 'draft'` → 跳转到灵感模式继续对话
  - 其他状态 → 跳转到写作台

**文件：`frontend/src/components/ProjectCard.vue`**
- 修改 `getStatusText` 计算属性（第 136-157 行）
- 增加状态判断逻辑：
  - `status === 'draft'` → 显示"灵感模式进行中"
  - `status === 'need_part_outlines'` → 显示"需要生成部分大纲"
  - 其他根据章节完成情况显示

## 测试场景

### 场景 1：新建项目中途中断后恢复

**前置条件：**
- 用户已登录

**测试步骤：**
1. 进入灵感模式（点击首页的"开启灵感模式"）
2. 完成 2-3 轮概念对话（不要完成整个对话流程）
3. 关闭浏览器或刷新页面
4. 重新打开应用，进入"我的小说项目"工作台
5. 查看刚才创建的项目卡片
6. 点击该项目的"继续创作"按钮

**预期结果：**
- 步骤 5：项目卡片上显示状态为"灵感模式进行中"
- 步骤 6：跳转到灵感模式页面，并恢复之前的对话历史
- 对话历史中包含之前的 2-3 轮问答
- 可以继续进行对话

### 场景 2：蓝图生成完成的项目

**前置条件：**
- 已有一个完成了灵感对话并生成蓝图的项目

**测试步骤：**
1. 进入"我的小说项目"工作台
2. 查看已完成蓝图的项目卡片
3. 点击"继续创作"按钮

**预期结果：**
- 步骤 2：项目状态显示为"准备创作"或"蓝图完成"（取决于是否有章节）
- 步骤 3：跳转到写作台（/novel/{id}），而不是灵感模式

### 场景 3：长篇小说项目（>50章）

**前置条件：**
- 已有一个生成了 50+ 章节大纲的项目
- 项目状态为 `need_part_outlines`

**测试步骤：**
1. 进入"我的小说项目"工作台
2. 查看该长篇小说项目卡片
3. 点击"继续创作"按钮

**预期结果：**
- 步骤 2：项目状态显示为"需要生成部分大纲"
- 步骤 3：跳转到写作台，写作台界面显示"生成部分大纲"按钮

### 场景 4：已有章节的项目

**前置条件：**
- 已有一个生成了部分章节的项目（例如完成了 3/10 章）

**测试步骤：**
1. 进入"我的小说项目"工作台
2. 查看该项目卡片
3. 点击"继续创作"按钮

**预期结果：**
- 步骤 2：项目状态显示"已完成 3/10 章"，进度条显示 30%
- 步骤 3：跳转到写作台，可以继续生成剩余章节

### 场景 5：多项目状态混合显示

**前置条件：**
- 用户有多个不同状态的项目：
  - 至少 1 个 draft 状态（未完成灵感对话）
  - 至少 1 个 blueprint_ready 状态（已生成蓝图）
  - 至少 1 个有章节的项目

**测试步骤：**
1. 进入"我的小说项目"工作台
2. 浏览所有项目卡片

**预期结果：**
- 每个项目卡片显示准确的状态文本：
  - draft → "灵感模式进行中"
  - need_part_outlines → "需要生成部分大纲"
  - 有章节 → "已完成 X/Y 章"
  - 仅有蓝图 → "准备创作"或"蓝图完成"
- 点击不同项目的"继续创作"按钮，跳转到正确的界面

## 回归测试检查项

- [ ] 新建项目流程正常（开启灵感模式 → 对话 → 生成蓝图 → 保存）
- [ ] 灵感模式的对话恢复功能正常（localStorage 三层恢复机制）
- [ ] 写作台功能正常（章节生成、版本选择等）
- [ ] 项目删除功能正常
- [ ] 项目详情查看功能正常
- [ ] 管理后台功能正常（如有权限）

## 技术说明

### 项目状态字段说明

`NovelProject.status` 可能的值（后端定义）：

1. **`draft`** （草稿）
   - 默认状态
   - 项目刚创建或正在进行概念对话
   - 蓝图尚未生成或不完整

2. **`blueprint_ready`** （蓝图就绪）
   - 蓝图生成完成（短篇小说，50 章以内）
   - 可以开始生成章节

3. **`need_part_outlines`** （需要部分大纲）
   - 长篇小说（>50 章）
   - 需要先生成部分大纲，再生成详细章节大纲
   - 是一种分层的大纲生成策略

### 判断逻辑对比

**之前的实现（不可靠）：**
```typescript
if (project.title === '未命名灵感') {
  router.push(`/inspiration?project_id=${project.id}`)
} else {
  router.push(`/novel/${project.id}`)
}
```

问题：
- 用户可能修改了标题但仍在对话中
- 蓝图生成时会自动更新标题，但如果失败了标题可能仍是"未命名灵感"
- 无法准确反映项目真实状态

**现在的实现（准确）：**
```typescript
if (project.status === 'draft') {
  router.push(`/inspiration?project_id=${project.id}`)
} else {
  router.push(`/novel/${project.id}`)
}
```

优势：
- 基于后端维护的准确状态字段
- 状态转换由后端业务逻辑控制
- 前端只需简单判断即可

### 数据流

```
用户操作
  ↓
前端请求 GET /api/novels
  ↓
后端 novel_service.list_projects_for_user()
  ↓
查询数据库获取 NovelProject 对象（包含 status 字段）
  ↓
构建 NovelProjectSummary 响应（包含 status）
  ↓
前端接收数据
  ↓
ProjectCard 组件根据 status 显示状态文本
  ↓
NovelWorkspace 根据 status 决定跳转目标
```

## 验证完成标准

所有测试场景通过，且满足以下条件：

1. ✅ draft 状态的项目能正确跳转到灵感模式并恢复对话
2. ✅ 非 draft 状态的项目能正确跳转到写作台
3. ✅ 项目卡片显示准确的状态文本
4. ✅ 进度条计算正确（已完成章节/总章节）
5. ✅ 回归测试检查项全部通过
6. ✅ 无控制台错误或警告

## 注意事项

1. **后端兼容性**：确保后端服务已更新并重启，否则前端会收到缺少 `status` 字段的响应
2. **缓存清理**：测试前建议清除浏览器缓存或使用无痕模式，避免旧数据干扰
3. **数据库迁移**：本次修改不需要数据库迁移，因为 `status` 字段已存在于 `novel_projects` 表中
4. **向后兼容**：旧版本创建的项目默认 status 为 'draft'，符合预期行为
